<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Carbamazepine Trial Tracker</title>
    <meta name="description" content="Lightweight daily tracker for Carbamazepine titration, symptoms, and side effects. Data stays in your browser. Export JSON or CSV for GitHub.">
    <meta property="og:title" content="Carbamazepine Trial Tracker">
    <meta property="og:description" content="Lightweight daily tracker for Carbamazepine titration, symptoms, and side effects.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://jamessaint.github.io/images/seed-of-life-gold.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Carbamazepine Trial Tracker">
    <meta name="twitter:description" content="Lightweight daily tracker for Carbamazepine titration, symptoms, and side effects.">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="global_styles.css" rel="stylesheet" />
    <style>
        .range-output {
      font-weight: 600;
      min-width: 2ch;
      display: inline-block;
      text-align: right;
    }

    .small-label {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .btn-wrap {
      gap: .5rem;
      display: flex;
      flex-wrap: wrap;
    }

    .import-input { display: none; }
  </style>
</head>

<body>
    <main class="content">
        <header class="mb-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/medical/">Medical</a></li>
                    <li class="breadcrumb-item"><a href="/medical/neurological">Neurological</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Carbamazepine Trial Tracker</li>
                </ol>
            </nav>
            <h1>Carbamazepine Trial Tracker</h1>
            <p class="meta">Data is stored locally in browser. Export regularly and commit JSON to your GitHub repo.</p>
        </header>
        <section class="section card-like">
            <h2>Quick Entry</h2>
            <form id="entryForm">
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Date</label>
                        <input type="date" id="date" class="form-control" required>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Time</label>
                        <input type="time" id="time" class="form-control" required>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Dose (mg)</label>
                        <input type="range" id="dose" class="form-range" min="0" max="1200" step="100" value="0" oninput="out_dose.textContent=value">
                        <div><span class="small-label">Selected:</span> <span id="out_dose" class="range-output">0</span> mg</div>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Pain (0 to 10)</label>
                        <input type="range" id="pain" class="form-range" min="0" max="10" step="1" value="0" oninput="out_pain.textContent=value">
                        <div><span class="small-label">Selected:</span> <span id="out_pain" class="range-output">0</span></div>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Sedation / Sleepiness (0 to 10)</label>
                        <input type="range" id="sedation" class="form-range" min="0" max="10" step="1" value="0" oninput="out_sedation.textContent=value">
                        <div><span class="small-label">Selected:</span> <span id="out_sedation" class="range-output">0</span></div>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Dizziness (0 to 10)</label>
                        <input type="range" id="dizziness" class="form-range" min="0" max="10" step="1" value="0" oninput="out_dizziness.textContent=value">
                        <div><span class="small-label">Selected:</span> <span id="out_dizziness" class="range-output">0</span></div>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Nausea (0 to 10)</label>
                        <input type="range" id="nausea" class="form-range" min="0" max="10" step="1" value="0" oninput="out_nausea.textContent=value">
                        <div><span class="small-label">Selected:</span> <span id="out_nausea" class="range-output">0</span></div>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Brain Fog / Clarity (0 to 10)</label>
                        <input type="range" id="brainfog" class="form-range" min="0" max="10" step="1" value="0" oninput="out_brainfog.textContent=value">
                        <div><span class="small-label">Selected:</span> <span id="out_brainfog" class="range-output">0</span></div>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Sleep (hours)</label>
                        <input type="range" id="sleep" class="form-range" min="0" max="14" step="1" value="7" oninput="out_sleep.textContent=value">
                        <div><span class="small-label">Selected:</span> <span id="out_sleep" class="range-output">7</span> h</div>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label d-block">Appetite</label>
                        <div class="btn-group" role="group" aria-label="Appetite">
                            <input type="radio" class="btn-check" name="appetite" id="app_low" autocomplete="off" value="Low">
                            <label class="btn btn-outline-primary" for="app_low">Low</label>
                            <input type="radio" class="btn-check" name="appetite" id="app_norm" autocomplete="off" value="Normal" checked>
                            <label class="btn btn-outline-primary" for="app_norm">Normal</label>
                            <input type="radio" class="btn-check" name="appetite" id="app_high" autocomplete="off" value="High">
                            <label class="btn btn-outline-primary" for="app_high">High</label>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label d-block">Notable Effects</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="fx_itch" value="Itching">
                            <label class="form-check-label" for="fx_itch">Itching</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="fx_vision" value="Vision change">
                            <label class="form-check-label" for="fx_vision">Vision change</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="fx_headache" value="Headache">
                            <label class="form-check-label" for="fx_headache">Headache</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="fx_gi" value="GI upset">
                            <label class="form-check-label" for="fx_gi">GI upset</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Notes</label>
                        <textarea id="notes" class="form-control" rows="2" placeholder="Optional short note"></textarea>
                    </div>
                </div>
                <div class="btn-wrap mt-3">
                    <button type="submit" class="btn btn-primary">Save Entry</button>
                    <button type="button" id="btn-clear-today" class="btn btn-outline-secondary">Clear Today</button>
                </div>
            </form>
        </section>
        <section id="entries" class="section card-like">
            <h2>Entries</h2>
            <div class="btn-wrap mb-2 d-flex flex-wrap align-items-center gap-2">
                <button type="button" id="btn-export-json" class="btn btn-success">Export JSON</button>
                <button type="button" id="btn-export-csv" class="btn btn-success">Export CSV</button>
                <button type="button" id="btn-import-json" class="btn btn-outline-primary">Import JSON</button>
                <input type="file" id="import-file" class="import-input" accept=".json,application/json">
                <button type="button" id="btn-clear-all" class="btn btn-outline-danger">Clear All</button>
                <!-- Safe export and archive buttons -->
                <button type="button" id="btn-safe-export" class="btn btn-primary">Safe Export (Merge First)</button>
                <button type="button" id="btn-archive-snapshot" class="btn btn-outline-secondary">Archive Snapshot</button>
                <!-- Data Source Switch -->
                <div class="d-inline-flex align-items-center gap-2 ms-auto">
                    <label for="data-source" class="small mb-0 text-uppercase fw-semibold">Data source:</label>
                    <select id="data-source" class="form-select form-select-sm" style="width:auto;">
                        <option value="local" selected>Local (This Browser)</option>
                        <option value="repo">Repo (GitHub JSON)</option>
                        <option value="merged">Merged (Repo + Local)</option>
                    </select>
                    <span id="source-status" class="small text-muted"></span>
                </div>
            </div>
            <div class="table-responsive entries-wrap">
                <table id="entriesTable" class="entries-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th class="num">Dose</th>
                            <th class="num">Pain</th>
                            <th class="num">Sedation</th>
                            <th class="num">Dizziness</th>
                            <th class="num">Nausea</th>
                            <th class="num">Brain Fog</th>
                            <th class="num">Sleep</th>
                            <th>Appetite</th>
                            <th>Effects</th>
                            <th>Notes</th>
                            <th class="actions-col">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </main>
    <script>
    /* Carbamazepine Tracker – entries table with repo diagnostics & safe merge */
    const KEY = 'carbamazepine_entries_v1';
    const REPO_JSON_URL = 'https://jamessaint.github.io/medical/neurological/carbamazepine-tracker.json';

    // Unique per-device prefix for entry IDs
    const DEVICE_ID = (() => {
        const k = 'carbamazepine_device_id';
        let v = localStorage.getItem(k);
        if (!v) {
            v = (window.crypto ? .randomUUID ? .() || ('dev-' + Date.now() + '-' + Math.random().toString(36).slice(2)));
            localStorage.setItem(k, v);
        }
        return v;
    })();

    function uid() {
        const core = window.crypto ? .randomUUID ?
            crypto.randomUUID() :
            (Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 10));
        return `${DEVICE_ID}-${core}`;
    }

    function nowDate() {
        const d = new Date();
        const pad = n => String(n).padStart(2, '0');
        return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate());
    }

    function nowTime() {
        const d = new Date();
        const pad = n => String(n).padStart(2, '0');
        return pad(d.getHours()) + ':' + pad(d.getMinutes());
    }

    function loadEntries() {
        try {
            const raw = localStorage.getItem(KEY);
            return raw ? JSON.parse(raw) : [];
        } catch {
            return [];
        }
    }

    function saveEntries(entries) {
        localStorage.setItem(KEY, JSON.stringify(entries));
    }

    function escapeHTML(s) {
        return String(s).replace(/[<>&]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;' } [c]));
    }

    function badge(text) {
        return `<span class="badge-soft">${escapeHTML(text)}</span>`;
    }

    function formToEntry() {
        const appetite = document.querySelector('input[name="appetite"]:checked') ? .value || 'Normal';
        const effects = [];
        ['fx_itch', 'fx_vision', 'fx_headache', 'fx_gi'].forEach(id => {
            const el = document.getElementById(id);
            if (el && el.checked) effects.push(el.value);
        });
        return {
            id: uid(),
            date: document.getElementById('date').value,
            time: document.getElementById('time').value,
            dose: Number(document.getElementById('dose').value),
            pain: Number(document.getElementById('pain').value),
            sedation: Number(document.getElementById('sedation').value),
            dizziness: Number(document.getElementById('dizziness').value),
            nausea: Number(document.getElementById('nausea').value),
            brainfog: Number(document.getElementById('brainfog').value),
            sleep: Number(document.getElementById('sleep').value),
            appetite,
            effects,
            notes: document.getElementById('notes').value.trim()
        };
    }

    function entryRow(entry) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
      <td data-label="Date">${entry.date}</td>
      <td data-label="Time">${entry.time}</td>
      <td class="num" data-label="Dose">${entry.dose}</td>
      <td class="num" data-label="Pain">${entry.pain}</td>
      <td class="num" data-label="Sedation">${entry.sedation}</td>
      <td class="num" data-label="Dizziness">${entry.dizziness}</td>
      <td class="num" data-label="Nausea">${entry.nausea}</td>
      <td class="num" data-label="Brain Fog">${entry.brainfog}</td>
      <td class="num" data-label="Sleep">${entry.sleep}</td>
      <td data-label="Appetite">${badge(entry.appetite)}</td>
      <td data-label="Effects">${(entry.effects || []).map(badge).join(' ')}</td>
      <td class="notes" data-label="Notes">${entry.notes ? escapeHTML(entry.notes) : ''}</td>
      <td class="actions d-flex gap-1" data-label="Actions">
        <button class="btn btn-outline-secondary btn-sm" data-action="edit" data-id="${entry.id}">Edit</button>
        <button class="btn btn-outline-danger btn-sm" data-action="delete" data-id="${entry.id}">Delete</button>
      </td>`;
        return tr;
    }

    function renderEmptyRow(message) {
        const tbody = document.querySelector('#entriesTable tbody');
        const cols = document.querySelectorAll('#entriesTable thead th').length || 13;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="${cols}" class="text-center py-3 small text-muted">${message}</td>`;
        tbody.appendChild(tr);
    }

    function renderTableFrom(entries) {
        const tbody = document.querySelector('#entriesTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (!entries || entries.length === 0) {
            renderEmptyRow('No data found. Try "Repo (GitHub JSON)" or "Merged", or add a local entry.');
            return;
        }
        entries
            .slice()
            .sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time))
            .forEach(e => tbody.appendChild(entryRow(e)));
    }

    function renderTable() {
        renderTableFrom(loadEntries());
    }

    // Normalize and merge helpers
    function normalizeEntries(arr) {
        return arr.map(e => ({
            id: e.id ? ? `${e.date}_${e.time}_${e.dose}`,
            date: e.date ? ? '',
            time: e.time ? ? '',
            dose: Number(e.dose ? ? 0),
            pain: Number(e.pain ? ? 0),
            sedation: Number(e.sedation ? ? 0),
            dizziness: Number(e.dizziness ? ? 0),
            nausea: Number(e.nausea ? ? 0),
            brainfog: Number(e.brainfog ? ? 0),
            sleep: Number(e.sleep ? ? 0),
            appetite: e.appetite ? ? 'Normal',
            effects: Array.isArray(e.effects) ? e.effects : String(e.effects ? ? '').split(';').map(s => s.trim()).filter(Boolean),
            notes: e.notes ? ? ''
        }));
    }

    function mergeDedup(a, b) {
        const map = new Map();
        const put = e => {
            const key = e.id || `${e.date}_${e.time}_${e.dose}`;
            const prev = map.get(key);
            if (!prev) map.set(key, e);
            else {
                const A = (prev.date || '') + (prev.time || '');
                const B = (e.date || '') + (e.time || '');
                if (B > A) map.set(key, e);
            }
        };
        normalizeEntries(a).forEach(put);
        normalizeEntries(b).forEach(put);
        return Array.from(map.values());
    }

    async function loadEntriesRepo() {
        const status = document.getElementById('source-status');
        const stamp = Date.now();
        try {
            status && (status.textContent = 'Loading repo…');
            const res = await fetch(`${REPO_JSON_URL}?ts=${stamp}`, { cache: 'no-store' });

            if (!res.ok) {
                const msg = `Repo HTTP ${res.status}`;
                status && (status.textContent = msg);
                console.error(msg);
                return [];
            }

            let data;
            try {
                data = await res.json();
            } catch (e) {
                status && (status.textContent = 'Repo: invalid JSON');
                console.error('Repo JSON parse error:', e);
                return [];
            }

            const arr = Array.isArray(data) ? data : (Array.isArray(data ? .entries) ? data.entries : []);
            status && (status.textContent = `Repo: ${arr.length} rows`);
            return normalizeEntries(arr);
        } catch (err) {
            const msg = `Repo load failed: ${err.message || err}`;
            status && (status.textContent = msg);
            console.error(msg);
            return [];
        }
    }

    async function loadEntriesMerged() {
        const local = loadEntries();
        const repo = await loadEntriesRepo();
        return mergeDedup(local, repo);
    }

    // Timestamp for archive filenames
    function stamp() {
        const d = new Date();
        const p = n => String(n).padStart(2, '0');
        return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`;
    }

    // ===== Initialization =====
    document.addEventListener('DOMContentLoaded', () => {
        const dateEl = document.getElementById('date');
        if (dateEl && 'valueAsDate' in dateEl) dateEl.valueAsDate = new Date();
        const timeEl = document.getElementById('time');
        if (timeEl) timeEl.value = nowTime();

        const selector = document.getElementById('data-source');
        const status = document.getElementById('source-status');

        async function renderBySource() {
            const val = selector ? .value || 'local';
            if (val === 'local') {
                status && (status.textContent = `Local: ${loadEntries().length} rows`);
                renderTable();
            } else if (val === 'repo') {
                const repo = await loadEntriesRepo();
                renderTableFrom(repo);
            } else {
                const merged = await loadEntriesMerged();
                status && (status.textContent = `Merged: ${merged.length} rows`);
                renderTableFrom(merged);
            }
        }

        renderBySource();
        selector ? .addEventListener('change', renderBySource);

        // Form submit
        const form = document.getElementById('entryForm');
        if (form) {
            form.addEventListener('submit', e => {
                e.preventDefault();
                const entry = formToEntry();
                const entries = loadEntries();
                entries.push(entry);
                saveEntries(entries);
                if ((selector ? .value || 'local') !== 'repo') renderBySource();
                form.reset();
                if (dateEl && 'valueAsDate' in dateEl) dateEl.valueAsDate = new Date();
                if (timeEl) timeEl.value = nowTime();
            });
        }

        // Table actions
        const table = document.querySelector('#entriesTable');
        table ? .addEventListener('click', ev => {
            const btn = ev.target.closest('button[data-action]');
            if (!btn) return;
            const id = btn.getAttribute('data-id');
            const action = btn.getAttribute('data-action');
            let entries = loadEntries();
            const idx = entries.findIndex(e => e.id === id);
            if (idx === -1) return;
            if (action === 'delete') {
                entries.splice(idx, 1);
                saveEntries(entries);
                renderBySource();
            } else if (action === 'edit') {
                const entry = entries[idx];
                document.getElementById('date').value = entry.date;
                document.getElementById('time').value = entry.time;
                document.getElementById('dose').value = entry.dose;
                document.getElementById('notes').value = entry.notes;
                entries.splice(idx, 1);
                saveEntries(entries);
                renderBySource();
            }
        });

        // Export / Import / Clear
        document.getElementById('btn-export-json') ? .addEventListener('click', () => {
            const data = JSON.stringify(loadEntries(), null, 2);
            download('carbamazepine-tracker.json', data, 'application/json');
        });

        document.getElementById('btn-export-csv') ? .addEventListener('click', () => {
            const data = toCSV(loadEntries());
            download('carbamazepine-tracker.csv', data, 'text/csv');
        });

        const importInput = document.getElementById('import-file');
        document.getElementById('btn-import-json') ? .addEventListener('click', () => importInput.click());
        importInput ? .addEventListener('change', e => {
            const file = e.target.files ? . [0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const arr = JSON.parse(reader.result);
                    if (Array.isArray(arr)) {
                        saveEntries(arr);
                        renderBySource();
                    } else alert('Invalid JSON format');
                } catch { alert('Import failed'); }
            };
            reader.readAsText(file);
        });

        document.getElementById('btn-clear-all') ? .addEventListener('click', () => {
            if (confirm('Clear all entries stored in this browser?')) {
                saveEntries([]);
                renderBySource();
            }
        });

        // Safe export & archive
        document.getElementById('btn-safe-export') ? .addEventListener('click', async () => {
            const local = loadEntries();
            const repo = await loadEntriesRepo();
            const merged = mergeDedup(local, repo);
            const json = JSON.stringify(merged, null, 2);
            download('carbamazepine-tracker.json', json, 'application/json');
        });

        document.getElementById('btn-archive-snapshot') ? .addEventListener('click', async () => {
            const local = loadEntries();
            const repo = await loadEntriesRepo();
            const merged = mergeDedup(local, repo);
            const json = JSON.stringify(merged, null, 2);
            download(`carbamazepine-tracker-${stamp()}.json`, json, 'application/json');
        });
    });
    </script>
</body>

</html>